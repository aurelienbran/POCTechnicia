{% extends "dashboard/base.html" %}

{% block title %}Tâches Actives - Tableau de Bord OCR{% endblock %}

{% block page_title %}Tâches OCR Actives{% endblock %}

{% block page_actions %}
<div class="btn-group me-2">
    <button type="button" class="btn btn-sm btn-outline-primary" id="refresh-active-tasks">
        <i class="fas fa-sync-alt"></i> Rafraîchir
    </button>
</div>
<div class="btn-group me-2">
    <a href="{{ url_for('dashboard_new_task') }}" class="btn btn-sm btn-outline-success">
        <i class="fas fa-plus"></i> Nouvelle tâche
    </a>
</div>
{% endblock %}

{% block content %}
<!-- Filtres et recherche -->
<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-filter me-1"></i>
        Filtres
    </div>
    <div class="card-body">
        <form id="filter-form" class="row g-3 align-items-end">
            <div class="col-md-3">
                <label for="provider-filter" class="form-label">Fournisseur OCR</label>
                <select class="form-select" id="provider-filter" name="provider">
                    <option value="">Tous</option>
                    {% for provider in ocr_providers %}
                    <option value="{{ provider }}">{{ provider }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label for="status-filter" class="form-label">État</label>
                <select class="form-select" id="status-filter" name="status">
                    <option value="">Tous</option>
                    <option value="running">En cours</option>
                    <option value="paused">En pause</option>
                    <option value="pending">En attente</option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="search-input" class="form-label">Recherche</label>
                <input type="text" class="form-control" id="search-input" name="search" placeholder="Nom ou ID de tâche">
            </div>
            <div class="col-md-2 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-search"></i> Filtrer
                </button>
                <button type="reset" class="btn btn-secondary">
                    <i class="fas fa-times"></i> Réinitialiser
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Tâches actives -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <div>
            <i class="fas fa-tasks me-1"></i>
            Tâches actives ({{ active_tasks|length }})
        </div>
        <div id="bulk-actions" class="btn-group btn-group-sm">
            <button type="button" class="btn btn-outline-warning btn-pause-all" disabled>
                <i class="fas fa-pause"></i> Mettre en pause
            </button>
            <button type="button" class="btn btn-outline-danger btn-cancel-all" disabled>
                <i class="fas fa-times"></i> Tout annuler
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="active-tasks-table">
                <thead>
                    <tr>
                        <th>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="select-all-tasks">
                                <label class="form-check-label" for="select-all-tasks"></label>
                            </div>
                        </th>
                        <th>ID</th>
                        <th>Nom</th>
                        <th>Document</th>
                        <th>Méthode OCR</th>
                        <th>État</th>
                        <th>Progression</th>
                        <th>Temps écoulé</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for task in active_tasks %}
                    <tr id="task-row-{{ task.task_id }}" data-task-id="{{ task.task_id }}">
                        <td>
                            <div class="form-check">
                                <input class="form-check-input task-checkbox" type="checkbox" value="{{ task.task_id }}" id="task-check-{{ task.task_id }}">
                                <label class="form-check-label" for="task-check-{{ task.task_id }}"></label>
                            </div>
                        </td>
                        <td><small>{{ task.task_id|truncate(8, True, '') }}</small></td>
                        <td>{{ task.name }}</td>
                        <td><small>{{ task.document_path|basename }}</small></td>
                        <td>{{ task.ocr_provider }}</td>
                        <td class="task-state">
                            <span class="badge bg-{{ task.state|state_color }}">{{ task.state|state_label }}</span>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     style="width: {{ task.progress * 100 }}%;" 
                                     aria-valuenow="{{ task.progress * 100 }}" 
                                     aria-valuemin="0" 
                                     aria-valuemax="100">
                                    {{ task.progress|format_percent }}
                                </div>
                            </div>
                            <small class="text-muted">Page {{ task.current_page + 1 }}/{{ task.total_pages }}</small>
                        </td>
                        <td class="task-duration" data-started="{{ task.started_at }}">{{ task.duration|format_duration }}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('dashboard_task_detail', task_id=task.task_id) }}" class="btn btn-outline-primary" title="Voir les détails">
                                    <i class="fas fa-eye"></i>
                                </a>
                                {% if task.state == 'running' %}
                                <button type="button" class="btn btn-outline-warning btn-pause-task" data-task-id="{{ task.task_id }}" title="Mettre en pause">
                                    <i class="fas fa-pause"></i>
                                </button>
                                {% elif task.state == 'paused' %}
                                <button type="button" class="btn btn-outline-primary btn-resume-task" data-task-id="{{ task.task_id }}" title="Reprendre">
                                    <i class="fas fa-play"></i>
                                </button>
                                {% endif %}
                                <button type="button" class="btn btn-outline-danger btn-cancel-task" data-task-id="{{ task.task_id }}" title="Annuler">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="9" class="text-center">Aucune tâche active</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Vue d'ensemble de l'activité système -->
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-chart-line me-1"></i>
                Activité de traitement OCR
            </div>
            <div class="card-body">
                <canvas id="ocrActivityChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-server me-1"></i>
                Utilisation des ressources
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>CPU</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-info" role="progressbar" style="width: {{ system_resources.cpu_usage }}%;" aria-valuenow="{{ system_resources.cpu_usage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ system_resources.cpu_usage }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Mémoire</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-warning" role="progressbar" style="width: {{ system_resources.memory_usage }}%;" aria-valuenow="{{ system_resources.memory_usage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ system_resources.memory_usage }}%
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>Disque</h6>
                        <div class="progress mb-2" style="height: 20px;">
                            <div class="progress-bar bg-success" role="progressbar" style="width: {{ system_resources.disk_usage }}%;" aria-valuenow="{{ system_resources.disk_usage }}" aria-valuemin="0" aria-valuemax="100">
                                {{ system_resources.disk_usage }}%
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>Tâches en file d'attente</h6>
                        <div class="d-flex align-items-center">
                            <h3 class="mb-0 me-2">{{ system_resources.queue_size }}</h3>
                            <span class="text-muted">tâches</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialiser les tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Gestionnaire pour le bouton de rafraîchissement
        document.getElementById('refresh-active-tasks').addEventListener('click', function() {
            location.reload();
        });
        
        // Gestionnaire pour le formulaire de filtre
        document.getElementById('filter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Récupérer les valeurs des filtres
            const provider = document.getElementById('provider-filter').value;
            const status = document.getElementById('status-filter').value;
            const search = document.getElementById('search-input').value;
            
            // Filtrer le tableau
            const rows = document.querySelectorAll('#active-tasks-table tbody tr');
            
            rows.forEach(row => {
                let visible = true;
                
                // Vérifier le fournisseur OCR
                if (provider && row.querySelector('td:nth-child(5)')) {
                    const rowProvider = row.querySelector('td:nth-child(5)').textContent.trim();
                    if (rowProvider !== provider) {
                        visible = false;
                    }
                }
                
                // Vérifier l'état
                if (status && row.querySelector('.task-state .badge')) {
                    const rowStateClass = row.querySelector('.task-state .badge').classList.toString();
                    const stateMapping = {
                        'running': 'bg-primary',
                        'paused': 'bg-warning',
                        'pending': 'bg-secondary'
                    };
                    
                    if (!rowStateClass.includes(stateMapping[status])) {
                        visible = false;
                    }
                }
                
                // Vérifier la recherche
                if (search) {
                    const rowName = row.querySelector('td:nth-child(3)').textContent.toLowerCase();
                    const rowId = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
                    const searchLower = search.toLowerCase();
                    
                    if (!rowName.includes(searchLower) && !rowId.includes(searchLower)) {
                        visible = false;
                    }
                }
                
                // Afficher ou masquer la ligne
                row.style.display = visible ? '' : 'none';
            });
        });
        
        // Gestionnaire pour le bouton de réinitialisation des filtres
        document.querySelector('#filter-form button[type="reset"]').addEventListener('click', function() {
            // Afficher toutes les lignes
            document.querySelectorAll('#active-tasks-table tbody tr').forEach(row => {
                row.style.display = '';
            });
        });
        
        // Sélection de tâches
        const selectAllCheckbox = document.getElementById('select-all-tasks');
        const taskCheckboxes = document.querySelectorAll('.task-checkbox');
        const bulkActionButtons = {
            pauseAll: document.querySelector('.btn-pause-all'),
            cancelAll: document.querySelector('.btn-cancel-all')
        };
        
        // Gestionnaire pour la case à cocher "Tout sélectionner"
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            
            // Mettre à jour toutes les cases à cocher des tâches
            taskCheckboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            // Mettre à jour l'état des boutons d'action en masse
            updateBulkActionButtons();
        });
        
        // Gestionnaire pour les cases à cocher des tâches
        taskCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                // Mettre à jour l'état de la case à cocher "Tout sélectionner"
                const allChecked = Array.from(taskCheckboxes).every(cb => cb.checked);
                const someChecked = Array.from(taskCheckboxes).some(cb => cb.checked);
                
                selectAllCheckbox.checked = allChecked;
                selectAllCheckbox.indeterminate = someChecked && !allChecked;
                
                // Mettre à jour l'état des boutons d'action en masse
                updateBulkActionButtons();
            });
        });
        
        // Mettre à jour l'état des boutons d'action en masse
        function updateBulkActionButtons() {
            const selectedCount = Array.from(taskCheckboxes).filter(cb => cb.checked).length;
            
            Object.values(bulkActionButtons).forEach(button => {
                button.disabled = selectedCount === 0;
            });
        }
        
        // Gestionnaire pour le bouton "Mettre en pause tout"
        bulkActionButtons.pauseAll.addEventListener('click', function() {
            const selectedTaskIds = Array.from(taskCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (selectedTaskIds.length === 0) return;
            
            if (confirm(`Êtes-vous sûr de vouloir mettre en pause ${selectedTaskIds.length} tâches ?`)) {
                // Mettre en pause toutes les tâches sélectionnées
                Promise.all(selectedTaskIds.map(taskId => {
                    return DashboardAPI.updateTaskState(taskId, 'paused');
                }))
                .then(() => {
                    // Recharger la page après un court délai
                    setTimeout(() => location.reload(), 500);
                })
                .catch(error => {
                    console.error(error);
                    alert('Erreur lors de la mise en pause des tâches sélectionnées.');
                });
            }
        });
        
        // Gestionnaire pour le bouton "Tout annuler"
        bulkActionButtons.cancelAll.addEventListener('click', function() {
            const selectedTaskIds = Array.from(taskCheckboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            if (selectedTaskIds.length === 0) return;
            
            if (confirm(`Êtes-vous sûr de vouloir annuler ${selectedTaskIds.length} tâches ? Cette action est irréversible.`)) {
                // Annuler toutes les tâches sélectionnées
                Promise.all(selectedTaskIds.map(taskId => {
                    return DashboardAPI.updateTaskState(taskId, 'failed', {
                        metadata: {
                            cancelled: true,
                            cancelled_at: new Date().toISOString()
                        }
                    });
                }))
                .then(() => {
                    // Recharger la page après un court délai
                    setTimeout(() => location.reload(), 500);
                })
                .catch(error => {
                    console.error(error);
                    alert('Erreur lors de l\'annulation des tâches sélectionnées.');
                });
            }
        });
        
        // Initialiser le graphique d'activité
        setupActivityChart();
        
        // Mise à jour des durées
        updateDurations();
        
        // Écouter les événements de mise à jour des tâches
        setupRealTimeUpdates();
    });
    
    // Mise à jour des durées
    function updateDurations() {
        const durationElements = document.querySelectorAll('.task-duration');
        durationElements.forEach(element => {
            const startedAt = element.getAttribute('data-started');
            if (startedAt) {
                const startTime = new Date(startedAt);
                const now = new Date();
                const durationMs = now - startTime;
                element.textContent = formatDuration(durationMs / 1000);
            }
        });
        
        setTimeout(updateDurations, 1000);
    }
    
    // Formater une durée en secondes
    function formatDuration(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        
        return `${h > 0 ? h + 'h ' : ''}${m > 0 || h > 0 ? m + 'm ' : ''}${s}s`;
    }
    
    // Configuration des mises à jour en temps réel
    function setupRealTimeUpdates() {
        // Écouter les événements de mise à jour des tâches
        document.addEventListener('task-updated', function(event) {
            updateTaskRow(event.detail);
        });
        
        // Écouter les événements de suppression de tâches
        document.addEventListener('task-deleted', function(event) {
            const taskRow = document.getElementById(`task-row-${event.detail}`);
            if (taskRow) {
                taskRow.remove();
            }
        });
    }
    
    // Mise à jour d'une ligne de tâche
    function updateTaskRow(task) {
        const row = document.getElementById(`task-row-${task.task_id}`);
        if (!row) return;
        
        // Mettre à jour la progression
        const progressBar = row.querySelector('.progress-bar');
        if (progressBar) {
            const progressPercent = task.progress * 100;
            progressBar.style.width = `${progressPercent}%`;
            progressBar.setAttribute('aria-valuenow', progressPercent);
            progressBar.textContent = `${progressPercent.toFixed(1)}%`;
        }
        
        // Mettre à jour la page actuelle
        const pageCounter = row.querySelector('small.text-muted');
        if (pageCounter) {
            pageCounter.textContent = `Page ${task.current_page + 1}/${task.total_pages}`;
        }
        
        // Mettre à jour l'état
        const stateCell = row.querySelector('.task-state');
        if (stateCell && task.state) {
            const stateMapping = {
                'pending': { color: 'secondary', label: 'En attente' },
                'running': { color: 'primary', label: 'En cours' },
                'paused': { color: 'warning', label: 'En pause' },
                'completed': { color: 'success', label: 'Terminée' },
                'failed': { color: 'danger', label: 'Erreur' },
                'retrying': { color: 'info', label: 'Nouvelle tentative' }
            };
            
            const stateInfo = stateMapping[task.state] || { color: 'secondary', label: 'Inconnu' };
            stateCell.innerHTML = `<span class="badge bg-${stateInfo.color}">${stateInfo.label}</span>`;
        }
        
        // Mettre à jour les boutons d'action en fonction de l'état
        const actionsCell = row.querySelector('td:last-child');
        if (actionsCell) {
            const buttonsHtml = `
                <div class="btn-group btn-group-sm">
                    <a href="/dashboard/tasks/${task.task_id}" class="btn btn-outline-primary" title="Voir les détails">
                        <i class="fas fa-eye"></i>
                    </a>
                    ${task.state === 'running' ? 
                      `<button type="button" class="btn btn-outline-warning btn-pause-task" data-task-id="${task.task_id}" title="Mettre en pause">
                          <i class="fas fa-pause"></i>
                       </button>` : 
                      task.state === 'paused' ?
                      `<button type="button" class="btn btn-outline-primary btn-resume-task" data-task-id="${task.task_id}" title="Reprendre">
                          <i class="fas fa-play"></i>
                       </button>` : ''
                    }
                    <button type="button" class="btn btn-outline-danger btn-cancel-task" data-task-id="${task.task_id}" title="Annuler">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            actionsCell.innerHTML = buttonsHtml;
            
            // Réattacher les gestionnaires d'événements
            const pauseButton = actionsCell.querySelector('.btn-pause-task');
            if (pauseButton) {
                pauseButton.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    DashboardAPI.updateTaskState(taskId, 'paused')
                        .then(() => {
                            // Recharger la ligne de la tâche
                            DashboardAPI.getTaskDetails(taskId).then(updatedTask => {
                                updateTaskRow(updatedTask);
                            });
                        })
                        .catch(error => {
                            console.error(error);
                            alert('Erreur lors de la mise en pause de la tâche.');
                        });
                });
            }
            
            const resumeButton = actionsCell.querySelector('.btn-resume-task');
            if (resumeButton) {
                resumeButton.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    DashboardAPI.updateTaskState(taskId, 'running')
                        .then(() => {
                            // Recharger la ligne de la tâche
                            DashboardAPI.getTaskDetails(taskId).then(updatedTask => {
                                updateTaskRow(updatedTask);
                            });
                        })
                        .catch(error => {
                            console.error(error);
                            alert('Erreur lors de la reprise de la tâche.');
                        });
                });
            }
            
            const cancelButton = actionsCell.querySelector('.btn-cancel-task');
            if (cancelButton) {
                cancelButton.addEventListener('click', function() {
                    const taskId = this.getAttribute('data-task-id');
                    
                    if (confirm('Êtes-vous sûr de vouloir annuler cette tâche ?')) {
                        DashboardAPI.updateTaskState(taskId, 'failed', {
                            metadata: {
                                cancelled: true,
                                cancelled_at: new Date().toISOString()
                            }
                        })
                        .then(() => {
                            // Recharger la page
                            location.reload();
                        })
                        .catch(error => {
                            console.error(error);
                            alert('Erreur lors de l\'annulation de la tâche.');
                        });
                    }
                });
            }
        }
        
        // Si la tâche est terminée, recharger la page après un délai
        if (task.state === 'completed' || task.state === 'failed') {
            setTimeout(() => location.reload(), 1000);
        }
    }
    
    // Configuration du graphique d'activité
    function setupActivityChart() {
        const ctx = document.getElementById('ocrActivityChart').getContext('2d');
        
        // Récupérer les données d'activité (exemple)
        const activityData = {
            labels: Array.from({ length: 24 }, (_, i) => `${i}h`),
            datasets: [
                {
                    label: 'Pages traitées par heure',
                    data: [10, 15, 8, 12, 20, 25, 30, 35, 28, 20, 15, 10, 12, 18, 22, 25, 20, 15, 10, 5, 3, 2, 5, 8],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.4,
                    fill: true
                }
            ]
        };
        
        new Chart(ctx, {
            type: 'line',
            data: activityData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return context[0].label;
                            },
                            label: function(context) {
                                return `${context.parsed.y} pages traitées`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Nombre de pages'
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
